{% extends 'base.html' %}

{% block title %}Mapa de Búsqueda - TiendasGeo{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
    }
    .search-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .results-panel {
        max-height: 600px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Mapa de Tiendas y Productos</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="search-container">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group mb-3">
                        <input type="text" id="search-input" class="form-control" placeholder="¿Qué producto estás buscando?">
                        <button class="btn btn-primary" type="button" id="search-button">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Radio</span>
                        <select class="form-select" id="radio-select">
                            <option value="1">1 km</option>
                            <option value="2">2 km</option>
                            <option value="5" selected>5 km</option>
                            <option value="10">10 km</option>
                            <option value="20">20 km</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" id="location-button">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info" id="location-status" style="display: none;">
                <i class="fas fa-spinner fa-spin me-2"></i> Obteniendo tu ubicación...
            </div>
        </div>
        
        <div id="map"></div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Resultados</h5>
            </div>
            <div class="card-body results-panel" id="results-container">
                <p class="text-muted text-center py-5">
                    <i class="fas fa-search fa-2x mb-3"></i><br>
                    Busca productos o activa tu ubicación para ver tiendas cercanas
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let map;
    let userMarker;
    let markers = [];
    let userLocation = null;
    
    // Inicializar mapa
    function initMap() {
        // Crear mapa centrado en España
        map = L.map('map').setView([40.416775, -3.703790], 6);
        
        // Añadir capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Obtener ubicación del usuario
        document.getElementById('location-button').addEventListener('click', getUserLocation);
        
        // Configurar búsqueda
        document.getElementById('search-button').addEventListener('click', searchProducts);
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });
    }
    
    // Obtener ubicación del usuario
    function getUserLocation() {
        const statusElement = document.getElementById('location-status');
        statusElement.style.display = 'block';
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Actualizar mapa
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    
                    // Añadir marcador de usuario
                    if (userMarker) {
                        userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                    } else {
                        const userIcon = L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        });
                        
                        userMarker = L.marker([userLocation.lat, userLocation.lng], {
                            icon: userIcon,
                            title: 'Tu ubicación'
                        }).addTo(map);
                        
                        userMarker.bindPopup('Tu ubicación actual').openPopup();
                    }
                    
                    statusElement.style.display = 'none';
                    
                    // Buscar tiendas cercanas
                    searchNearbyStores();
                },
                function(error) {
                    statusElement.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> Error al obtener tu ubicación: ${error.message}`;
                    statusElement.classList.remove('alert-info');
                    statusElement.classList.add('alert-danger');
                }
            );
        } else {
            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> Tu navegador no soporta geolocalización';
            statusElement.classList.remove('alert-info');
            statusElement.classList.add('alert-danger');
        }
    }
    
    // Buscar tiendas cercanas
    function searchNearbyStores() {
        const radioSelect = document.getElementById('radio-select');
        const resultsContainer = document.getElementById('results-container');
        const radio = radioSelect.value;
        
        if (!userLocation) {
            return;
        }
        
        // Limpiar marcadores anteriores (excepto el del usuario)
        clearMarkers();
        
        // Mostrar cargando
        resultsContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Buscando tiendas cercanas...</p>
            </div>
        `;
        
        // Buscar tiendas cercanas
        fetch(`/api/tiendas/cercanas?lat=${userLocation.lat}&lng=${userLocation.lng}&radio=${radio}`)
            .then(response => response.json())
            .then(data => {
                if (data.resultados.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-5">
                            <p class="text-muted">No se encontraron tiendas en un radio de ${radio} km</p>
                        </div>
                    `;
                    return;
                }
                
                // Mostrar tiendas en el mapa
                const bounds = L.latLngBounds();
                bounds.extend([userLocation.lat, userLocation.lng]);
                
                data.resultados.forEach(tienda => {
                    const tiendaIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    });
                    
                    const marker = L.marker([tienda.latitud, tienda.longitud], {
                        icon: tiendaIcon,
                        title: tienda.nombre
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <strong>${tienda.nombre}</strong><br>
                        ${tienda.direccion}<br>
                        <strong>Distancia:</strong> ${tienda.distancia} km
                    `);
                    
                    markers.push(marker);
                    bounds.extend([tienda.latitud, tienda.longitud]);
                });
                
                // Ajustar vista del mapa
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Mostrar resultados
                let resultsHTML = `
                    <h6 class="mb-3">Tiendas cercanas (${data.resultados.length})</h6>
                `;
                
                data.resultados.forEach(tienda => {
                    resultsHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">${tienda.nombre}</h6>
                                <p class="card-text small">
                                    <i class="fas fa-map-marker-alt me-2"></i>${tienda.direccion}<br>
                                    <i class="fas fa-route me-2"></i>Distancia: ${tienda.distancia} km
                                </p>
                                <button class="btn btn-sm btn-outline-primary ver-tienda" data-lat="${tienda.latitud}" data-lng="${tienda.longitud}" data-id="${tienda.id}">
                                    Ver en mapa
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                resultsContainer.innerHTML = resultsHTML;
                
                // Añadir eventos a los botones
                document.querySelectorAll('.ver-tienda').forEach(button => {
                    button.addEventListener('click', function() {
                        const lat = parseFloat(this.getAttribute('data-lat'));
                        const lng = parseFloat(this.getAttribute('data-lng'));
                        map.setView([lat, lng], 16);
                        
                        // Buscar y abrir el popup del marcador
                        markers.forEach(marker => {
                            const markerLatLng = marker.getLatLng();
                            if (markerLatLng.lat === lat && markerLatLng.lng === lng) {
                                marker.openPopup();
                            }
                        });
                    });
                });
            })
            .catch(error => {
                console.error('Error:', error);
                resultsContainer.innerHTML = `
                    <div class="text-center py-5">
                        <p class="text-danger">Error al buscar tiendas cercanas. Inténtalo de nuevo.</p>
                    </div>
                `;
            });
    }
    
    // Buscar productos
    function searchProducts() {
        const searchInput = document.getElementById('search-input');
        const radioSelect = document.getElementById('radio-select');
        const resultsContainer = document.getElementById('results-container');
        
        const termino = searchInput.value.trim();
        const radio = radioSelect.value;
        
        if (termino === '') {
            return;
        }
        
        // Limpiar marcadores anteriores (excepto el del usuario)
        clearMarkers();
        
        // Mostrar cargando
        resultsContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Buscando "${termino}"...</p>
            </div>
        `;
        
        // Si tenemos ubicación del usuario, buscar productos cercanos
        if (userLocation) {
            fetch(`/api/buscar/producto-cercano?termino=${encodeURIComponent(termino)}&lat=${userLocation.lat}&lng=${userLocation.lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultsContainer.innerHTML = `
                            <div class="text-center py-5">
                                <p class="text-muted">${data.error}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Mostrar tienda en el mapa
                    const tienda = data.tienda;
                    const tiendaIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    });
                    
                    const marker = L.marker([tienda.latitud, tienda.longitud], {
                        icon: tiendaIcon,
                        title: tienda.nombre
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <strong>${tienda.nombre}</strong><br>
                        ${tienda.direccion}<br>
                        <strong>Distancia:</strong> ${tienda.distancia} km
                    `);
                    
                    markers.push(marker);
                    
                    // Ajustar vista del mapa para mostrar usuario y tienda
                    const bounds = L.latLngBounds(
                        L.latLng(userLocation.lat, userLocation.lng),
                        L.latLng(tienda.latitud, tienda.longitud)
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });
                    
                    // Mostrar resultados
                    let resultsHTML = `
                        <div class="alert alert-success mb-3">
                            <strong>¡Encontrado!</strong> Tienda más cercana con "${termino}"
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">${tienda.nombre}</h5>
                                <p class="card-text">
                                    <i class="fas fa-map-marker-alt me-2"></i>${tienda.direccion}<br>
                                    <i class="fas fa-route me-2"></i>Distancia: ${tienda.distancia} km
                                </p>
                            </div>
                        </div>
                        
                        <h6 class="mb-3">Productos disponibles (${data.productos.length})</h6>
                    `;
                    
                    // Mostrar productos
                    data.productos.forEach(producto => {
                        resultsHTML += `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">${producto.nombre}</h6>
                                    <p class="card-text small">
                                        ${producto.descripcion ? producto.descripcion.substring(0, 100) + (producto.descripcion.length > 100 ? '...' : '') : 'Sin descripción'}
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-primary fw-bold">${producto.precio.toFixed(2)} €</span>
                                        <span class="badge bg-${producto.stock > 0 ? 'success' : 'danger'}">
                                            ${producto.stock > 0 ? 'Disponible' : 'Agotado'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultsContainer.innerHTML = resultsHTML;
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultsContainer.innerHTML = `
                        <div class="text-center py-5">
                            <p class="text-danger">Error al buscar productos. Inténtalo de nuevo.</p>
                        </div>
                    `;
                });
        } else {
            // Si no tenemos ubicación, mostrar mensaje
            resultsContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Para buscar productos cercanos, primero debes activar tu ubicación haciendo clic en el botón <i class="fas fa-map-marker-alt"></i>
                </div>
                
                <div class="text-center py-4">
                    <button class="btn btn-primary" id="activate-location">
                        <i class="fas fa-map-marker-alt me-2"></i>Activar ubicación
                    </button>
                </div>
            `;
            
            // Añadir evento al botón
            document.getElementById('activate-location').addEventListener('click', getUserLocation);
        }
    }
    
    // Limpiar marcadores
    function clearMarkers() {
        markers.forEach(marker => {
            map.removeLayer(marker);
        });
        markers = [];
    }
    
    // Inicializar cuando el documento esté listo
    document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
